{% extends "base.html" %}
{% load i18n %}

{% block title %}{% trans "Client information" %}: {{ client.full_name }}{% endblock %}

{% block content %}
    <style>
        .client-page { max-width: 1200px; margin: 0 auto; }
        .client-page .form-card { margin-bottom: 16px; }
        .client-page h1 { margin: 0 0 12px 0; }
        .client-topbar {
            margin-bottom: 12px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            gap: 10px;
            flex-wrap: wrap;
        }
        .client-actions { display: flex; gap: 8px; align-items: center; flex-wrap: wrap; }
        .btn-small {
            background: #007bff;
            color: white;
            padding: 8px 12px;
            border-radius: 6px;
            border: none;
            text-decoration: none;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            font-size: 13px;
            font-weight: 600;
            cursor: pointer;
            margin-top: 0;
        }
        .btn-danger { background: #dc3545; }
        .btn-muted { background: #6c757d; }
        .btn-info { background: #17a2b8; }

        .profile-grid {
            display: grid;
            grid-template-columns: repeat(3, minmax(190px, 1fr));
            gap: 12px;
            margin-top: 14px;
        }
        .profile-item {
            background: #f8f9fa;
            border: 1px solid #e6e6e6;
            border-radius: 8px;
            padding: 10px 12px;
        }
        .profile-item strong { display: block; margin-bottom: 6px; font-size: 13px; color: #444; }
        .profile-item p { margin: 0; font-weight: 600; }
        .profile-item-wide { grid-column: 1 / -1; }

        .compact-form { display: grid; gap: 10px; }
        .compact-form-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
        }

        .history-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 16px;
            align-items: start;
        }
        .history-grid .full-row { grid-column: 1 / -1; }

        @media (max-width: 980px) {
            .profile-grid,
            .compact-form-grid,
            .history-grid {
                grid-template-columns: 1fr;
            }
            .history-grid .full-row { grid-column: auto; }
        }
    </style>

    <div class="client-page">

    <div class="client-topbar">
        <div>
            <a href="{% url 'dashboard' %}" style="color: #007bff; text-decoration: none;">‚Üê {% trans "Back to dashboard" %}</a>
        </div>
        <div class="client-actions">
            <a href="{% url 'edit_client' client.id %}" class="btn-small btn-info">
                {% trans "Edit client" %}
            </a>
            <form action="{% url 'delete_client' client.id %}" method="post" style="margin: 0;" onsubmit="return confirm('{% trans 'Are you sure you want to delete this client? This action cannot be undone.' %}');">
                {% csrf_token %}
                <button type="submit" class="btn-small btn-danger">
                    {% trans "Delete client" %}
                </button>
            </form>
        </div>
    </div>

    <h1>{% trans "Client information" %}</h1>

    <div class="form-card">
        <h2>{{ client.full_name }}</h2>

        <div class="profile-grid">
            <div class="profile-item">
                <strong>{% trans "Full name" %}:</strong>
                <p>{{ client.full_name }}</p>
            </div>

            {% if client.client_type %}
            <div class="profile-item">
                <strong>{% trans "Client type" %}:</strong>
                <p>
                    {% if client.client_type == 'child' %}
                        {% trans "Child" %}
                    {% elif client.client_type == 'teenager' %}
                        {% trans "Teenager" %}
                    {% else %}
                        {% trans "Adult" %}
                    {% endif %}
                </p>
            </div>
            {% endif %}

            {% if client.date_of_birth %}
            <div class="profile-item">
                <strong>{% trans "Date of birth" %}:</strong>
                <p>{{ client.date_of_birth|date:"d.m.Y" }}</p>
            </div>
            {% endif %}

            {% if client.phone %}
            <div class="profile-item">
                <strong>{% trans "Phone" %}:</strong>
                <p>{{ client.phone }}</p>
            </div>
            {% endif %}

            {% if client.address %}
            <div class="profile-item profile-item-wide">
                <strong>{% trans "Address" %}:</strong>
                <p>{{ client.address }}</p>
            </div>
            {% endif %}

            {% if client.referral_source %}
            <div class="profile-item profile-item-wide">
                <strong>{% trans "How did you hear about us?" %}:</strong>
                <p>{{ client.referral_source }}</p>
            </div>
            {% endif %}

            <div class="profile-item">
                <strong>{% trans "Balance" %}:</strong>
                <p style="font-size: 1.2em; font-weight: bold; color: #28a745;">{{ client.balance }} AZN</p>
            </div>

            <div class="profile-item">
                <strong>{% trans "Lessons balance" %}:</strong>
                <p style="font-size: 1.2em; font-weight: bold; color: #007bff;">{{ client.lessons_balance }}</p>
            </div>

            <div class="profile-item">
                <strong>{% trans "Total sessions" %}:</strong>
                <p>{{ total_sessions }}</p>
            </div>

            <div class="profile-item">
                <strong>{% trans "Total spent" %}:</strong>
                <p>{{ total_spent }} AZN</p>
            </div>

            <div class="profile-item">
                <strong>{% trans "Total deposited" %}:</strong>
                <p>{{ total_deposited }} AZN</p>
            </div>

            <div class="profile-item">
                <strong>{% trans "Total top-up cancellations" %}:</strong>
                <p>{{ total_adjusted }} AZN</p>
            </div>

            <div class="profile-item">
                <strong>{% trans "Created at" %}:</strong>
                <p>{{ client.created_at|date:"d.m.Y H:i" }}</p>
            </div>
        </div>
    </div>

    <div class="form-card">
        <h3>{% trans "Top-up cancellation" %}</h3>
        <form class="compact-form" method="post" action="{% url 'adjust_client_balance' client.id %}">
            {% csrf_token %}
            <div class="compact-form-grid">
                <div>
                    <label for="amount_removed"><strong>{% trans "Removed amount" %} (AZN):</strong></label>
                    <input type="number" id="amount_removed" name="amount_removed" min="0" step="0.01" value="0">
                </div>
                <div>
                    <label for="lessons_removed"><strong>{% trans "Removed lessons" %}:</strong></label>
                    <input type="number" id="lessons_removed" name="lessons_removed" min="0" step="1" value="0">
                </div>
            </div>
            <div>
                <button class="btn-small btn-danger" type="submit">{% trans "Cancel top-up and print receipt" %}</button>
            </div>
        </form>
    </div>

    <div class="history-grid">
    {% if recent_transactions %}
    <div class="form-card">
        <h3>{% trans "Recent transactions" %}</h3>
        <table>
            <thead>
                <tr>
                    <th>{% trans "Date/time" %}</th>
                    <th>{% trans "Worker" %}</th>
                    <th>{% trans "Amount" %}</th>
                    <th>{% trans "Lessons" %}</th>
                    <th>{% trans "Actions" %}</th>
                </tr>
            </thead>
            <tbody>
                {% for tx in recent_transactions %}
                <tr>
                    <td>{{ tx.date_time|date:"d.m.Y H:i" }}</td>
                    <td>{{ tx.worker.user.username }}</td>
                    <td>{{ tx.amount }} AZN</td>
                    <td>{{ tx.lessons_count }}</td>
                    <td>
                        <a href="{% url 'view_receipt' tx.id %}" class="btn-small btn-info">{% trans "View receipt" %}</a>
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
    {% endif %}

    {% if recent_deposits %}
    <div class="form-card">
        <h3>{% trans "Recent deposits" %}</h3>
        <table>
            <thead>
                <tr>
                    <th>{% trans "Date/time" %}</th>
                    <th>{% trans "Amount" %}</th>
                </tr>
            </thead>
            <tbody>
                {% for deposit in recent_deposits %}
                <tr>
                    <td>{{ deposit.date_time|date:"d.m.Y H:i" }}</td>
                    <td>{{ deposit.amount }} AZN</td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
    {% endif %}

    {% if recent_adjustments %}
    <div class="form-card full-row">
        <h3>{% trans "Top-up cancellation history" %}</h3>
        <table>
            <thead>
                <tr>
                    <th>{% trans "Date/time" %}</th>
                    <th>{% trans "Removed amount" %}</th>
                    <th>{% trans "Removed lessons" %}</th>
                    <th>{% trans "Actions" %}</th>
                </tr>
            </thead>
            <tbody>
                {% for adjustment in recent_adjustments %}
                <tr>
                    <td>{{ adjustment.date_time|date:"d.m.Y H:i" }}</td>
                    <td>{{ adjustment.amount_removed }} AZN</td>
                    <td>{{ adjustment.lessons_removed }}</td>
                    <td>
                        <a href="{% url 'view_adjustment_receipt' adjustment.id %}" class="btn-small btn-info">{% trans "View receipt" %}</a>
                        <a href="{% url 'view_adjustment_receipt' adjustment.id %}?print=1" class="btn-small btn-muted" target="_blank">{% trans "Print" %}</a>
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
    {% endif %}
    </div>
    </div>
{% endblock %}

