{% extends "base.html" %}
{% load i18n %}

{% block title %}{% trans "Control Panel" %}{% endblock %}

{% block content %}
    {% get_current_language as CURRENT_LANG %}
    <style>
        .dashboard-page button { margin-top: 0; }
        .dashboard-toolbar {
            display: flex;
            justify-content: space-between;
            align-items: center;
            gap: 12px;
            flex-wrap: wrap;
            margin-bottom: 16px;
        }
        .btn-link {
            text-decoration: none;
            display: inline-flex;
            align-items: center;
            justify-content: center;
        }
        .btn-sm {
            padding: 9px 14px;
            border-radius: 6px;
            border: none;
            font-size: 13px;
            font-weight: 600;
            line-height: 1;
        }
        .btn-primary { background: #007bff; color: #fff; }
        .btn-success { background: #28a745; color: #fff; }
        .btn-info { background: #17a2b8; color: #fff; }
        .input-hint { display: block; margin-top: 4px; font-size: 12px; }
        .input-hint a { color: #007bff; text-decoration: none; }
        .operation-tag {
            color: #fff;
            padding: 3px 8px;
            border-radius: 999px;
            font-size: 11px;
            font-weight: 700;
            display: inline-block;
        }
        .operation-tag--session { background: #28a745; }
        .operation-tag--deposit { background: #17a2b8; }
        .dashboard-actions {
            display: flex;
            gap: 6px;
            align-items: center;
            flex-wrap: nowrap;
        }
        .dashboard-actions .btn-sm { padding: 6px 10px; font-size: 12px; }
    </style>

    <div class="dashboard-page">
    <div class="dashboard-toolbar">
        <h1 style="margin: 0;">{% trans "Control Panel" %}</h1>
        <a href="{% url 'create_client' %}" class="btn-link btn-sm btn-success">{% trans "Add new client" %}</a>
    </div>

    {% if messages %}
        <ul class="messages">
            {% for message in messages %}
                <li class="{{ message.tags }}">{{ message }}</li>
            {% endfor %}
        </ul>
    {% endif %}
    
    <div class="form-container">
        <div class="form-card form-card--narrow" id="session-form">
            <h2>{% trans "Process Session" %}</h2>
            <form action="{% url 'dashboard' %}" method="POST">
                {% csrf_token %}

                <input type="hidden" name="action_type" value="process_session">

                <div>
                    <label for="client_session_display">{% trans "Client" %}:</label>
                    <input list="client_session_list"
                           id="client_session_display"
                           name="client_session_display"
                              placeholder="{% if CURRENT_LANG == 'ru' %}Поиск клиента{% elif CURRENT_LANG == 'az' %}Müştəri axtar{% else %}Search client{% endif %}"
                           autocomplete="off">
                    <input type="hidden" id="client_session" name="client_id" required>
                    <datalist id="client_session_list">
                        {% for client in clients %}
                            <option data-id="{{ client.id }}" value="{{ client.full_name }} ({{ client.balance }} AZN / {% trans "Lessons" %}: {{ client.lessons_balance }})"></option>
                        {% endfor %}
                    </datalist>
                    <small class="input-hint"><a href="{% url 'create_client' %}">{% trans "Add new client" %}</a></small>
                </div>

                <div>
                    <label for="worker_session_display">{% trans "Worker" %}:</label>
                    <input list="worker_session_list"
                           id="worker_session_display"
                           name="worker_session_display"
                              placeholder="{% if CURRENT_LANG == 'ru' %}Поиск сотрудника{% elif CURRENT_LANG == 'az' %}Mütəxəssis axtar{% else %}Search worker{% endif %}"
                              autocomplete="off">
                    <input type="hidden" id="worker_session" name="worker_id" required>
                    <datalist id="worker_session_list">
                        {% for worker in workers %}
                            <option data-id="{{ worker.id }}" value="{{ worker.user.username }}"></option>
                        {% endfor %}
                    </datalist>
                </div>

                <div>
                    <label for="session_cost">{% trans "Session cost" %}:</label>
                    <input type="number" id="session_cost" name="session_cost" step="0.01" required placeholder="0.00">
                </div>

                <div>
                    <label for="session_lessons">{% trans "Lessons to charge" %}:</label>
                    <input type="number" id="session_lessons" name="session_lessons" min="1" step="1" required placeholder="1">
                </div>

                <button type="submit" class="btn-sm btn-primary">{% trans "Process payment and print receipt" %}</button>
            </form>
        </div>

        <div class="form-card form-card--narrow">
            <h2>{% trans "Top up client balance" %}</h2>
            <form action="{% url 'dashboard' %}" method="POST">
                {% csrf_token %}
                <input type="hidden" name="action_type" value="deposit">

                <div>
                    <label for="client_deposit_display">{% trans "Client" %}:</label>
                    <input list="client_deposit_list"
                           id="client_deposit_display"
                           name="client_deposit_display"
                              placeholder="{% if CURRENT_LANG == 'ru' %}Поиск клиента{% elif CURRENT_LANG == 'az' %}Müştəri axtar{% else %}Search client{% endif %}"
                           autocomplete="off">
                    <input type="hidden" id="client_deposit" name="client_id" required>
                    <datalist id="client_deposit_list">
                        {% for client in clients %}
                            <option data-id="{{ client.id }}" value="{{ client.full_name }} ({{ client.balance }} AZN / {% trans "Lessons" %}: {{ client.lessons_balance }})"></option>
                        {% endfor %}
                    </datalist>
                    <small class="input-hint"><a href="{% url 'create_client' %}">{% trans "Add new client" %}</a></small>
                </div>

                <div>
                    <label for="amount">{% trans "Top-up amount" %}:</label>
                    <input type="number" id="amount" name="deposit_amount" step="0.01" required placeholder="0.00">
                </div>

                <div>
                    <label for="deposit_lessons">{% trans "Lessons to add" %}:</label>
                    <input type="number" id="deposit_lessons" name="deposit_lessons" min="0" step="1" required placeholder="0">
                </div>

                <button type="submit" class="btn-sm btn-info">{% trans "Top up" %}</button>
            </form>
        </div>

    </div>
    <div class="form-card">
        <h2>{% trans "Recent operations" %}</h2>
        {% if recent_operations %}
        <table>
            <thead>
                <tr>
                    <th>{% trans "Date/time" %}</th>
                    <th>{% trans "Type" %}</th>
                    <th>{% trans "Client" %}</th>
                    <th>{% trans "Worker" %}</th>
                    <th>{% trans "Amount" %}</th>
                    <th>{% trans "Lessons" %}</th>
                    <th>{% trans "Transaction #" %}</th>
                    <th>{% trans "Actions" %}</th>
                </tr>
            </thead>
            <tbody>
            {% for op in recent_operations %}
                <tr>
                    <td>{{ op.date_time|date:"d.m.Y H:i" }}</td>
                    <td>
                        {% if op.type == 'transaction' %}
                            <span class="operation-tag operation-tag--session">{% trans "Session" %}</span>
                        {% else %}
                            <span class="operation-tag operation-tag--deposit">{% trans "Top-up" %}</span>
                        {% endif %}
                    </td>
                    <td>
                        {% if op.type == 'transaction' %}
                            <a href="{% url 'view_client' op.transaction.client.id %}" style="color: #007bff; text-decoration: none; font-weight: 600;">{{ op.transaction.client.full_name }}</a>
                        {% else %}
                            <a href="{% url 'view_client' op.deposit.client.id %}" style="color: #007bff; text-decoration: none; font-weight: 600;">{{ op.deposit.client.full_name }}</a>
                        {% endif %}
                    </td>
                    <td>
                        {% if op.type == 'transaction' %}
                            {{ op.transaction.worker.user.username }}
                        {% else %}
                            -
                        {% endif %}
                    </td>
                    <td>
                        {% if op.type == 'transaction' %}
                            {{ op.transaction.amount }} AZN
                        {% else %}
                            {{ op.deposit.amount }} AZN
                        {% endif %}
                    </td>
                    <td>
                        {% if op.type == 'transaction' %}
                            {{ op.transaction.lessons_count }}
                        {% else %}
                            {{ op.deposit.lessons_added }}
                        {% endif %}
                    </td>
                    <td>
                        {% if op.type == 'transaction' %}
                            #{{ op.transaction.id }}
                        {% else %}
                            #{{ op.deposit.id }}
                        {% endif %}
                    </td>
                    <td>
                        <div class="dashboard-actions">
                            {% if op.type == 'transaction' %}
                                <a href="{% url 'view_receipt' op.transaction.id %}" class="btn-link btn-sm btn-info">{% trans "View" %}</a>
                                <a href="{% url 'view_receipt' op.transaction.id %}?print=1" target="_blank" class="btn-link btn-sm btn-success">{% trans "Print" %}</a>
                            {% else %}
                                <a href="{% url 'view_deposit_receipt' op.deposit.id %}" class="btn-link btn-sm btn-info">{% trans "View" %}</a>
                                <a href="{% url 'view_deposit_receipt' op.deposit.id %}?print=1" target="_blank" class="btn-link btn-sm btn-success">{% trans "Print" %}</a>
                            {% endif %}
                        </div>
                    </td>
                </tr>
            {% endfor %}
            </tbody>
        </table>
        {% else %}
            <p>{% trans "No operations yet." %}</p>
        {% endif %}
    </div>
    </div>
{% endblock %}

{% block extra_scripts %}
<script>
(function() {
    function wireDatalist(displayId, hiddenId, listId) {
        const display = document.getElementById(displayId);
        const hidden = document.getElementById(hiddenId);
        const options = Array.from(document.getElementById(listId).children);
        if (!display || !hidden) return;

        function tryMatch() {
            const val = display.value.toLowerCase();
            const match = options.find(o => o.value.toLowerCase() === val);
            if (match) {
                hidden.value = match.dataset.id;
            } else {
                hidden.value = '';
            }
        }

        display.addEventListener('input', tryMatch);
        display.addEventListener('change', tryMatch);
        display.addEventListener('blur', tryMatch);
    }

    wireDatalist('client_session_display', 'client_session', 'client_session_list');
    wireDatalist('worker_session_display', 'worker_session', 'worker_session_list');
    wireDatalist('client_deposit_display', 'client_deposit', 'client_deposit_list');
})();
</script>
{% endblock %}
