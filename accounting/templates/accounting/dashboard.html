{% extends "base.html" %}

{% block title %}Панель управления{% endblock %}

{% block content %}
    <h1>Панель управления Психологического Центра</h1>

    {% if messages %}
        <ul class="messages">
            {% for message in messages %}
                <li class="{{ message.tags }}">{{ message }}</li>
            {% endfor %}
        </ul>
    {% endif %}
    <div class="form-container">
        <div class="form-card" id="session-form">
            <h2>Провести сеанс</h2>
            <form action="{% url 'dashboard' %}" method="POST">
                {% csrf_token %}

                <input type="hidden" name="action_type" value="process_session">

                <div>
                    <label for="client_session">Клиент:</label>
                    <select id="client_session" name="client_id" required>
                        <option value="">--- Выберите клиента ---</option>
                        {% for client in clients %}
                            <option value="{{ client.id }}">{{ client.full_name }} (Баланс: {{ client.balance }})</option>
                        {% endfor %}
                    </select>
                </div>

                <div>
                    <label for="worker_session">Сотрудник:</label>
                    <select id="worker_session" name="worker_id" required>
                        <option value="">--- Выберите сотрудника ---</option>
                        {% for worker in workers %}
                            <option value="{{ worker.id }}">{{ worker.user.username }}</option>
                        {% endfor %}
                    </select>
                </div>

                <div>
                    <label for="session_cost">Стоимость сеанса:</label>
                    <input type="number" id="session_cost" name="session_cost" step="0.01" required>
                </div>

                <button type="submit">Провести оплату и напечатать чек</button>
            </form>
        </div>

        <div class="form-card">
            <h2>Пополнить баланс клиента</h2>
            <form action="{% url 'dashboard' %}" method="POST">
                {% csrf_token %}
                <input type="hidden" name="action_type" value="deposit">

                <div>
                    <label for="client_deposit">Клиент:</label>
                    <select id="client_deposit" name="client_id" required>
                        <option value="">--- Выберите клиента ---</option>
                        {% for client in clients %}
                            <option value="{{ client.id }}">{{ client.full_name }}</option>
                        {% endfor %}
                    </select>
                </div>

                <div>
                    <label for="amount">Сумма пополнения:</label>
                    <input type="number" id="amount" name="deposit_amount" step="0.01" required>
                </div>

                <button type="submit">Пополнить</button>
            </form>
        </div>

    </div>
    <div class="form-card">
        <h2>Недавние операции (сеансы)</h2>
        {% if recent_transactions %}
        <table>
            <thead>
                <tr>
                    <th>Дата/время</th>
                    <th>Клиент</th>
                    <th>Сотрудник</th>
                    <th>Сумма</th>
                    <th>Статус чека</th>
                    <th>Действия</th>
                </tr>
            </thead>
            <tbody>
            {% for tx in recent_transactions %}
                <tr>
                    <td>{{ tx.date_time|date:"d.m.Y H:i" }}</td>
                    <td>{{ tx.client.full_name }}</td>
                    <td>{{ tx.worker.user.username }}</td>
                    <td>{{ tx.amount }}</td>
                    <td>
                        {% if tx.receipt_printed %}
                            Распечатан
                        {% else %}
                            Не распечатан
                        {% endif %}
                    </td>
                    <td>
                        <div style="display: flex; gap: 5px;">
                            <a href="{% url 'view_receipt' tx.id %}" style="background: #17a2b8; color: white; padding: 5px 10px; border-radius: 3px; text-decoration: none; font-size: 12px;">Просмотр</a>
                            <form method="post" action="{% url 'print_receipt' tx.id %}" style="display: inline;">
                                {% csrf_token %}
                                <button type="submit" style="background: #28a745; color: white; padding: 5px 10px; border: none; border-radius: 3px; cursor: pointer; font-size: 12px;">Печать</button>
                            </form>
                        </div>
                    </td>
                </tr>
            {% endfor %}
            </tbody>
        </table>
        {% else %}
            <p>Пока нет транзакций.</p>
        {% endif %}
    </div>
{% endblock %}