{% extends "base.html" %}
{% load i18n %}

{% block title %}{% trans "Control Panel" %}{% endblock %}

{% block content %}
    <h1>{% trans "Control Panel" %}</h1>

    {% if messages %}
        <ul class="messages">
            {% for message in messages %}
                <li class="{{ message.tags }}">{{ message }}</li>
            {% endfor %}
        </ul>
    {% endif %}
    <div class="form-container">
        <div class="form-card" id="session-form">
            <h2>{% trans "Process Session" %}</h2>
            <form action="{% url 'dashboard' %}" method="POST">
                {% csrf_token %}

                <input type="hidden" name="action_type" value="process_session">

                <div>
                    <label for="client_session">{% trans "Client" %}:</label>
                    <select id="client_session" name="client_id" required>
                        <option value="">--- {% trans "Select client" %} ---</option>
                        {% for client in clients %}
                            <option value="{{ client.id }}">{{ client.full_name }} ({% trans "Balance" %}: {{ client.balance }})</option>
                        {% endfor %}
                    </select>
                </div>

                <div>
                    <label for="worker_session">{% trans "Worker" %}:</label>
                    <select id="worker_session" name="worker_id" required>
                        <option value="">--- {% trans "Select worker" %} ---</option>
                        {% for worker in workers %}
                            <option value="{{ worker.id }}">{{ worker.user.username }}</option>
                        {% endfor %}
                    </select>
                </div>

                <div>
                    <label for="session_cost">{% trans "Session cost" %}:</label>
                    <input type="number" id="session_cost" name="session_cost" step="0.01" required>
                </div>

                <button type="submit">{% trans "Process payment and print receipt" %}</button>
            </form>
        </div>

        <div class="form-card">
            <h2>{% trans "Top up client balance" %}</h2>
            <form action="{% url 'dashboard' %}" method="POST">
                {% csrf_token %}
                <input type="hidden" name="action_type" value="deposit">

                <div>
                    <label for="client_deposit">{% trans "Client" %}:</label>
                    <select id="client_deposit" name="client_id" required>
                        <option value="">--- {% trans "Select client" %} ---</option>
                        {% for client in clients %}
                            <option value="{{ client.id }}">{{ client.full_name }}</option>
                        {% endfor %}
                    </select>
                </div>

                <div>
                    <label for="amount">{% trans "Top-up amount" %}:</label>
                    <input type="number" id="amount" name="deposit_amount" step="0.01" required>
                </div>

                <button type="submit">{% trans "Top up" %}</button>
            </form>
        </div>

    </div>
    <div class="form-card">
        <h2>{% trans "Recent transactions (sessions)" %}</h2>
        {% if recent_transactions %}
        <table>
            <thead>
                <tr>
                    <th>{% trans "Date/time" %}</th>
                    <th>{% trans "Client" %}</th>
                    <th>{% trans "Worker" %}</th>
                    <th>{% trans "Amount" %}</th>
                    <th>{% trans "Receipt status" %}</th>
                    <th>{% trans "Actions" %}</th>
                </tr>
            </thead>
            <tbody>
            {% for tx in recent_transactions %}
                <tr>
                    <td>{{ tx.date_time|date:"d.m.Y H:i" }}</td>
                    <td>{{ tx.client.full_name }}</td>
                    <td>{{ tx.worker.user.username }}</td>
                    <td>{{ tx.amount }}</td>
                    <td>
                        {% if tx.receipt_printed %}
                            {% trans "Printed" %}
                        {% else %}
                            {% trans "Not printed" %}
                        {% endif %}
                    </td>
                    <td>
                        <div style="display: flex; gap: 5px;">
                            <a href="{% url 'view_receipt' tx.id %}" style="background: #17a2b8; color: white; padding: 5px 10px; border-radius: 3px; text-decoration: none; font-size: 12px;">{% trans "View" %}</a>
                            <a href="{% url 'view_receipt' tx.id %}?print=1" target="_blank" style="background: #28a745; color: white; padding: 5px 10px; border-radius: 3px; text-decoration: none; font-size: 12px; display: inline-block;">{% trans "Print" %}</a>
                        </div>
                    </td>
                </tr>
            {% endfor %}
            </tbody>
        </table>
        {% else %}
            <p>{% trans "No transactions yet." %}</p>
        {% endif %}
    </div>
{% endblock %}
