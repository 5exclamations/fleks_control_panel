{% extends "base.html" %}
{% load i18n %}

{% block title %}{% trans "Control Panel" %}{% endblock %}

{% block content %}
    <h1>{% trans "Control Panel" %}</h1>

    {% if messages %}
        <ul class="messages">
            {% for message in messages %}
                <li class="{{ message.tags }}">{{ message }}</li>
            {% endfor %}
        </ul>
    {% endif %}
    
    <div style="margin-bottom: 20px;">
        <a href="{% url 'create_client' %}" style="background: #28a745; color: white; padding: 10px 20px; border-radius: 5px; text-decoration: none; display: inline-block; font-weight: bold;">{% trans "Add new client" %}</a>
    </div>
    
    <div class="form-container">
        <div class="form-card form-card--narrow" id="session-form">
            <h2>{% trans "Process Session" %}</h2>
            <form action="{% url 'dashboard' %}" method="POST">
                {% csrf_token %}

                <input type="hidden" name="action_type" value="process_session">

                <div>
                    <label for="client_session">{% trans "Client" %}:</label>
                    <select id="client_session" name="client_id" required>
                        <option value="">--- {% trans "Select client" %} ---</option>
                        {% for client in clients %}
                            <option value="{{ client.id }}">{{ client.full_name }} ({% trans "Balance" %}: {{ client.balance }})</option>
                        {% endfor %}
                    </select>
                    <small style="display: block; margin-top: 5px;"><a href="{% url 'create_client' %}" style="color: #007bff;">{% trans "Add new client" %}</a></small>
                </div>

                <div>
                    <label for="worker_session">{% trans "Worker" %}:</label>
                    <select id="worker_session" name="worker_id" required>
                        <option value="">--- {% trans "Select worker" %} ---</option>
                        {% for worker in workers %}
                            <option value="{{ worker.id }}">{{ worker.user.username }}</option>
                        {% endfor %}
                    </select>
                </div>

                <div>
                    <label for="session_cost">{% trans "Session cost" %}:</label>
                    <input type="number" id="session_cost" name="session_cost" step="0.01" required>
                </div>

                <button type="submit">{% trans "Process payment and print receipt" %}</button>
            </form>
        </div>

        <div class="form-card form-card--narrow">
            <h2>{% trans "Top up client balance" %}</h2>
            <form action="{% url 'dashboard' %}" method="POST">
                {% csrf_token %}
                <input type="hidden" name="action_type" value="deposit">

                <div>
                    <label for="client_deposit">{% trans "Client" %}:</label>
                    <select id="client_deposit" name="client_id" required>
                        <option value="">--- {% trans "Select client" %} ---</option>
                        {% for client in clients %}
                            <option value="{{ client.id }}">{{ client.full_name }}</option>
                        {% endfor %}
                    </select>
                    <small style="display: block; margin-top: 5px;"><a href="{% url 'create_client' %}" style="color: #007bff;">{% trans "Add new client" %}</a></small>
                </div>

                <div>
                    <label for="amount">{% trans "Top-up amount" %}:</label>
                    <input type="number" id="amount" name="deposit_amount" step="0.01" required>
                </div>

                <button type="submit">{% trans "Top up" %}</button>
            </form>
        </div>

    </div>
    <div class="form-card">
        <h2>{% trans "Recent operations" %}</h2>
        {% if recent_operations %}
        <table>
            <thead>
                <tr>
                    <th>{% trans "Date/time" %}</th>
                    <th>{% trans "Type" %}</th>
                    <th>{% trans "Client" %}</th>
                    <th>{% trans "Worker" %}</th>
                    <th>{% trans "Amount" %}</th>
                    <th>{% trans "Transaction #" %}</th>
                    <th>{% trans "Actions" %}</th>
                </tr>
            </thead>
            <tbody>
            {% for op in recent_operations %}
                <tr>
                    <td>{{ op.date_time|date:"d.m.Y H:i" }}</td>
                    <td>
                        {% if op.type == 'transaction' %}
                            <span style="background: #28a745; color: white; padding: 3px 8px; border-radius: 3px; font-size: 11px;">{% trans "Session" %}</span>
                        {% else %}
                            <span style="background: #17a2b8; color: white; padding: 3px 8px; border-radius: 3px; font-size: 11px;">{% trans "Top-up" %}</span>
                        {% endif %}
                    </td>
                    <td>
                        {% if op.type == 'transaction' %}
                            <a href="{% url 'view_client' op.transaction.client.id %}" style="color: #007bff; text-decoration: none;">{{ op.transaction.client.full_name }}</a>
                        {% else %}
                            <a href="{% url 'view_client' op.deposit.client.id %}" style="color: #007bff; text-decoration: none;">{{ op.deposit.client.full_name }}</a>
                        {% endif %}
                    </td>
                    <td>
                        {% if op.type == 'transaction' %}
                            {{ op.transaction.worker.user.username }}
                        {% else %}
                            -
                        {% endif %}
                    </td>
                    <td>
                        {% if op.type == 'transaction' %}
                            {{ op.transaction.amount }} AZN
                        {% else %}
                            {{ op.deposit.amount }} AZN
                        {% endif %}
                    </td>
                    <td>
                        {% if op.type == 'transaction' %}
                            #{{ op.transaction.id }}
                        {% else %}
                            #{{ op.deposit.id }}
                        {% endif %}
                    </td>
                    <td>
                        <div style="display: flex; gap: 5px;">
                            {% if op.type == 'transaction' %}
                                <a href="{% url 'view_receipt' op.transaction.id %}" style="background: #17a2b8; color: white; padding: 5px 10px; border-radius: 3px; text-decoration: none; font-size: 12px;">{% trans "View" %}</a>
                                <a href="{% url 'view_receipt' op.transaction.id %}?print=1" target="_blank" style="background: #28a745; color: white; padding: 5px 10px; border-radius: 3px; text-decoration: none; font-size: 12px; display: inline-block;">{% trans "Print" %}</a>
                            {% else %}
                                <a href="{% url 'view_deposit_receipt' op.deposit.id %}" style="background: #17a2b8; color: white; padding: 5px 10px; border-radius: 3px; text-decoration: none; font-size: 12px;">{% trans "View" %}</a>
                                <a href="{% url 'view_deposit_receipt' op.deposit.id %}?print=1" target="_blank" style="background: #28a745; color: white; padding: 5px 10px; border-radius: 3px; text-decoration: none; font-size: 12px; display: inline-block;">{% trans "Print" %}</a>
                            {% endif %}
                        </div>
                    </td>
                </tr>
            {% endfor %}
            </tbody>
        </table>
        {% else %}
            <p>{% trans "No operations yet." %}</p>
        {% endif %}
    </div>
{% endblock %}
